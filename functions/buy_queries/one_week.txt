WITH filter_data AS (
    SELECT
        UNNEST(%(symbols_list)s::TEXT[]) AS symbol,
        UNNEST(%(intervals_list)s::TEXT[]) AS interval,
        UNNEST(%(datetime_list)s::TIMESTAMPTZ[]) AS datetime
),
base_data AS (
    SELECT
        c.symbol AS base_symbol,
        c.interval AS base_interval,
        c.datetime AS base_datetime,
        c.open AS base_open,
        c.high AS base_high,
        c.low AS base_low,
        c.close AS base_close,
        c.volume AS base_volume,
        a.*
    FROM candle_data c
    JOIN all_indicators_data a
      ON c.symbol = a.symbol
     AND c.interval = a.interval
     AND c.datetime = a.datetime
    WHERE (c.symbol, c.interval, c.datetime) IN (
          SELECT symbol, interval, datetime FROM filter_data
    )
),
nifty_data AS (
    SELECT
        c.symbol AS nifty_symbol,
        c.interval AS nifty_interval,
        c.datetime AS nifty_datetime,
        c.open AS nifty_open,
        c.high AS nifty_high,
        c.low AS nifty_low,
        c.close AS nifty_close,
        a.*
    FROM candle_data c
    JOIN all_indicators_data a
      ON c.symbol = a.symbol
     AND c.interval = a.interval
     AND c.datetime = a.datetime
    WHERE c.symbol = 'NIFTY'
      AND (c.interval, c.datetime) IN (
          SELECT interval, datetime FROM filter_data
    )
)
SELECT
    -- Base data and its indicators
    b.base_symbol,
    b.base_interval,
    b.base_datetime,
    b.base_open,
    b.base_high,
    b.base_low,
    b.base_close,
    b.base_volume,
    b.aroon_up            AS base_aroon_up,
    b.aroon_down          AS base_aroon_down,
    b.adx                 AS base_adx,
    b.pdi                 AS base_pdi,
    b.mdi                 AS base_mdi,
    b.elderray_bull_power AS base_elderray_bull_power,
    b.elderray_bear_power AS base_elderray_bear_power,
    b.gator_upper         AS base_gator_upper,
    b.gator_lower         AS base_gator_lower,
    b.gator_is_upper_expanding AS base_gator_is_upper_expanding,
    b.gator_is_lower_expanding AS base_gator_is_lower_expanding,
    b.hurst               AS base_hurst,
    b.ichimoku_tenkan_sen AS base_ichimoku_tenkan_sen,
    b.ichimoku_kijun_sen  AS base_ichimoku_kijun_sen,
    b.ichimoku_senkou_span_a AS base_ichimoku_senkou_span_a,
    b.ichimoku_senkou_span_b AS base_ichimoku_senkou_span_b,
    b.ichimoku_chikou_span    AS base_ichimoku_chikou_span,
    b.macd                AS base_macd,
    b.macd_signal         AS base_macd_signal,
    b.macd_histogram      AS base_macd_histogram,
    b.supertrend          AS base_supertrend,
    b.vortex_pvi          AS base_vortex_pvi,
    b.vortex_nvi          AS base_vortex_nvi,
    b.alligator_jaw       AS base_alligator_jaw,
    b.alligator_teeth     AS base_alligator_teeth,
    b.alligator_lips      AS base_alligator_lips,
    b.bollingerbands_upper AS base_bollingerbands_upper,
    b.bollingerbands_lower AS base_bollingerbands_lower,
    b.donchianchannels_upper AS base_donchianchannels_upper,
    b.donchianchannels_lower AS base_donchianchannels_lower,
    b.fcb_upper           AS base_fcb_upper,
    b.fcb_lower           AS base_fcb_lower,
    b.keltnerchannels_upper  AS base_keltnerchannels_upper,
    b.keltnerchannels_lower  AS base_keltnerchannels_lower,
    b.keltnerchannels_center AS base_keltnerchannels_center,
    b.maenvelopes_upper   AS base_maenvelopes_upper,
    b.maenvelopes_lower   AS base_maenvelopes_lower,
    b.pivotpoints_pp      AS base_pivotpoints_pp,
    b.pivotpoints_r1      AS base_pivotpoints_r1,
    b.pivotpoints_s1      AS base_pivotpoints_s1,
    b.rollingpivotpoints_pp AS base_rollingpivotpoints_pp,
    b.rollingpivotpoints_r1 AS base_rollingpivotpoints_r1,
    b.rollingpivotpoints_s1 AS base_rollingpivotpoints_s1,
    b.starc_upper         AS base_starc_upper,
    b.starc_lower         AS base_starc_lower,
    b.standarddeviationchannels_upper AS base_standarddeviationchannels_upper,
    b.standarddeviationchannels_lower AS base_standarddeviationchannels_lower,
    b.awesomeoscillator   AS base_awesomeoscillator,
    b.cci                 AS base_cci,
    b.connorsrsi          AS base_connorsrsi,
    b.dpo                 AS base_dpo,
    b.rsi                 AS base_rsi,
    b.stc                 AS base_stc,
    b.smi                 AS base_smi,
    b.stochasticoscillator_k AS base_stochasticoscillator_k,
    b.stochasticoscillator_d AS base_stochasticoscillator_d,
    b.stochasticrsi_rsi   AS base_stochasticrsi_rsi,
    b.stochasticrsi_signal AS base_stochasticrsi_signal,
    b.trix                AS base_trix,
    b.ultimateoscillator  AS base_ultimateoscillator,
    b.williamsr           AS base_williamsr,
    b.chandelierexit      AS base_chandelierexit,
    b.parabolicsar        AS base_parabolicsar,
    b.volatilitystop      AS base_volatilitystop,
    b.williamsfractal_bull AS base_williamsfractal_bull,
    b.williamsfractal_bear AS base_williamsfractal_bear,
    b.adl                 AS base_adl,
    b.cmf                 AS base_cmf,
    b.chaikinoscillator   AS base_chaikinoscillator,
    b.forceindex          AS base_forceindex,
    b.kvo                 AS base_kvo,
    b.mfi                 AS base_mfi,
    b.obv                 AS base_obv,
    b.pvo                 AS base_pvo,
    b.alma                AS base_alma,
    b.dema                AS base_dema,
    b.epma                AS base_epma,
    b.ema5                AS base_ema5,
    b.ema9                AS base_ema9,
    b.ema13               AS base_ema13,
    b.ema50               AS base_ema50,
    b.hilberttransform    AS base_hilberttransform,
    b.hma                 AS base_hma,
    b.kama                AS base_kama,
    b.mama                AS base_mama,
    b.fama                AS base_fama,
    b.sma                 AS base_sma,
    b.smma                AS base_smma,
    b.t3                  AS base_t3,
    b.tema                AS base_tema,
    b.vwap                AS base_vwap,
    b.vwma                AS base_vwma,
    b.wma                 AS base_wma,
    b.fishertransform_fisher AS base_fishertransform_fisher,
    b.fishertransform_trigger AS base_fishertransform_trigger,
    b.zigzag              AS base_zigzag,
    b.atr                 AS base_atr,
    b.bop                 AS base_bop,
    b.choppinessindex     AS base_choppinessindex,
    b.pmo                 AS base_pmo,
    b.pmo_signal          AS base_pmo_signal,
    b.roc                 AS base_roc,
    b.truerange           AS base_truerange,
    b.tsi                 AS base_tsi,
    b.ulcerindex          AS base_ulcerindex,
    b.slope               AS base_slope,
    b.standarddeviation   AS base_standarddeviation,

    -- Nifty data for reference
    n.nifty_open,
    n.nifty_high,
    n.nifty_low,
    n.nifty_close,
    n.aroon_up           AS nifty_aroon_up,
    n.aroon_down         AS nifty_aroon_down,
    n.adx                AS nifty_adx,
    n.pdi                AS nifty_pdi,
    n.mdi                AS nifty_mdi,
    n.elderray_bull_power AS nifty_elderray_bull_power,
    n.elderray_bear_power AS nifty_elderray_bear_power,
    n.gator_upper        AS nifty_gator_upper,
    n.gator_lower        AS nifty_gator_lower,
    n.gator_is_upper_expanding AS nifty_gator_is_upper_expanding,
    n.gator_is_lower_expanding AS nifty_gator_is_lower_expanding,
    n.hurst              AS nifty_hurst,
    n.ichimoku_tenkan_sen AS nifty_ichimoku_tenkan_sen,
    n.ichimoku_kijun_sen AS nifty_ichimoku_kijun_sen,
    n.ichimoku_senkou_span_a AS nifty_ichimoku_senkou_span_a,
    n.ichimoku_senkou_span_b AS nifty_ichimoku_senkou_span_b,
    n.ichimoku_chikou_span   AS nifty_ichimoku_chikou_span,
    n.macd               AS nifty_macd,
    n.macd_signal        AS nifty_macd_signal,
    n.macd_histogram     AS nifty_macd_histogram,
    n.supertrend         AS nifty_supertrend,
    n.vortex_pvi         AS nifty_vortex_pvi,
    n.vortex_nvi         AS nifty_vortex_nvi,
    n.alligator_jaw      AS nifty_alligator_jaw,
    n.alligator_teeth    AS nifty_alligator_teeth,
    n.alligator_lips     AS nifty_alligator_lips,
    n.bollingerbands_upper AS nifty_bollingerbands_upper,
    n.bollingerbands_lower AS nifty_bollingerbands_lower,
    n.donchianchannels_upper AS nifty_donchianchannels_upper,
    n.donchianchannels_lower AS nifty_donchianchannels_lower,
    n.fcb_upper          AS nifty_fcb_upper,
    n.fcb_lower          AS nifty_fcb_lower,
    n.keltnerchannels_upper AS nifty_keltnerchannels_upper,
    n.keltnerchannels_lower AS nifty_keltnerchannels_lower,
    n.keltnerchannels_center AS nifty_keltnerchannels_center,
    n.maenvelopes_upper  AS nifty_maenvelopes_upper,
    n.maenvelopes_lower  AS nifty_maenvelopes_lower,
    n.pivotpoints_pp     AS nifty_pivotpoints_pp,
    n.pivotpoints_r1     AS nifty_pivotpoints_r1,
    n.pivotpoints_s1     AS nifty_pivotpoints_s1,
    n.rollingpivotpoints_pp AS nifty_rollingpivotpoints_pp,
    n.rollingpivotpoints_r1 AS nifty_rollingpivotpoints_r1,
    n.rollingpivotpoints_s1 AS nifty_rollingpivotpoints_s1,
    n.starc_upper        AS nifty_starc_upper,
    n.starc_lower        AS nifty_starc_lower,
    n.standarddeviationchannels_upper AS nifty_standarddeviationchannels_upper,
    n.standarddeviationchannels_lower AS nifty_standarddeviationchannels_lower,
    n.awesomeoscillator  AS nifty_awesomeoscillator,
    n.cci                AS nifty_cci,
    n.connorsrsi         AS nifty_connorsrsi,
    n.dpo                AS nifty_dpo,
    n.rsi                AS nifty_rsi,
    n.stc                AS nifty_stc,
    n.smi                AS nifty_smi,
    n.stochasticoscillator_k AS nifty_stochasticoscillator_k,
    n.stochasticoscillator_d AS nifty_stochasticoscillator_d,
    n.stochasticrsi_rsi   AS nifty_stochasticrsi_rsi,
    n.stochasticrsi_signal AS nifty_stochasticrsi_signal,
    n.trix               AS nifty_trix,
    n.ultimateoscillator AS nifty_ultimateoscillator,
    n.williamsr          AS nifty_williamsr,
    n.chandelierexit     AS nifty_chandelierexit,
    n.parabolicsar       AS nifty_parabolicsar,
    n.volatilitystop     AS nifty_volatilitystop,
    n.williamsfractal_bull AS nifty_williamsfractal_bull,
    n.williamsfractal_bear AS nifty_williamsfractal_bear,
    n.adl                AS nifty_adl,
    n.cmf                AS nifty_cmf,
    n.chaikinoscillator  AS nifty_chaikinoscillator,
    n.forceindex         AS nifty_forceindex,
    n.kvo                AS nifty_kvo,
    n.mfi                AS nifty_mfi,
    n.obv                AS nifty_obv,
    n.pvo                AS nifty_pvo,
    n.alma               AS nifty_alma,
    n.dema               AS nifty_dema,
    n.epma               AS nifty_epma,
    n.ema5               AS nifty_ema5,
    n.ema9               AS nifty_ema9,
    n.ema13              AS nifty_ema13,
    n.ema50              AS nifty_ema50,
    n.hilberttransform   AS nifty_hilberttransform,
    n.hma                AS nifty_hma,
    n.kama               AS nifty_kama,
    n.mama               AS nifty_mama,
    n.fama               AS nifty_fama,
    n.sma                AS nifty_sma,
    n.smma               AS nifty_smma,
    n.t3                 AS nifty_t3,
    n.tema               AS nifty_tema,
    n.vwap               AS nifty_vwap,
    n.vwma               AS nifty_vwma,
    n.wma                AS nifty_wma,
    n.fishertransform_fisher AS nifty_fishertransform_fisher,
    n.fishertransform_trigger AS nifty_fishertransform_trigger,
    n.zigzag             AS nifty_zigzag,
    n.atr                AS nifty_atr,
    n.bop                AS nifty_bop,
    n.choppinessindex    AS nifty_choppinessindex,
    n.pmo                AS nifty_pmo,
    n.pmo_signal         AS nifty_pmo_signal,
    n.roc                AS nifty_roc,
    n.truerange          AS nifty_truerange,
    n.tsi                AS nifty_tsi,
    n.ulcerindex         AS nifty_ulcerindex,
    n.slope              AS nifty_slope,
    n.standarddeviation  AS nifty_standarddeviation,

    -- Lateral join for previous ONE_MONTH candle (modified from ONE_HOUR)
    upper_data.open AS upper_open,
    upper_data.high AS upper_high,
    upper_data.low AS upper_low,
    upper_data.close AS upper_close,
    upper_data.volume AS upper_volume,
    upper_data.aroon_up AS upper_aroon_up,
    upper_data.aroon_down AS upper_aroon_down,
    upper_data.adx AS upper_adx,
    upper_data.pdi AS upper_pdi,
    upper_data.mdi AS upper_mdi,
    upper_data.elderray_bull_power AS upper_elderray_bull_power,
    upper_data.elderray_bear_power AS upper_elderray_bear_power,
    upper_data.gator_upper AS upper_gator_upper,
    upper_data.gator_lower AS upper_gator_lower,
    upper_data.gator_is_upper_expanding AS upper_gator_is_upper_expanding,
    upper_data.gator_is_lower_expanding AS upper_gator_is_lower_expanding,
    upper_data.hurst AS upper_hurst,
    upper_data.ichimoku_tenkan_sen AS upper_ichimoku_tenkan_sen,
    upper_data.ichimoku_kijun_sen AS upper_ichimoku_kijun_sen,
    upper_data.ichimoku_senkou_span_a AS upper_ichimoku_senkou_span_a,
    upper_data.ichimoku_senkou_span_b AS upper_ichimoku_senkou_span_b,
    upper_data.ichimoku_chikou_span AS upper_ichimoku_chikou_span,
    upper_data.macd AS upper_macd,
    upper_data.macd_signal AS upper_macd_signal,
    upper_data.macd_histogram AS upper_macd_histogram,
    upper_data.supertrend AS upper_supertrend,
    upper_data.vortex_pvi AS upper_vortex_pvi,
    upper_data.vortex_nvi AS upper_vortex_nvi,
    upper_data.alligator_jaw AS upper_alligator_jaw,
    upper_data.alligator_teeth AS upper_alligator_teeth,
    upper_data.alligator_lips AS upper_alligator_lips,
    upper_data.bollingerbands_upper AS upper_bollingerbands_upper,
    upper_data.bollingerbands_lower AS upper_bollingerbands_lower,
    upper_data.donchianchannels_upper AS upper_donchianchannels_upper,
    upper_data.donchianchannels_lower AS upper_donchianchannels_lower,
    upper_data.fcb_upper AS upper_fcb_upper,
    upper_data.fcb_lower AS upper_fcb_lower,
    upper_data.keltnerchannels_upper AS upper_keltnerchannels_upper,
    upper_data.keltnerchannels_lower AS upper_keltnerchannels_lower,
    upper_data.keltnerchannels_center AS upper_keltnerchannels_center,
    upper_data.maenvelopes_upper AS upper_maenvelopes_upper,
    upper_data.maenvelopes_lower AS upper_maenvelopes_lower,
    upper_data.pivotpoints_pp AS upper_pivotpoints_pp,
    upper_data.pivotpoints_r1 AS upper_pivotpoints_r1,
    upper_data.pivotpoints_s1 AS upper_pivotpoints_s1,
    upper_data.rollingpivotpoints_pp AS upper_rollingpivotpoints_pp,
    upper_data.rollingpivotpoints_r1 AS upper_rollingpivotpoints_r1,
    upper_data.rollingpivotpoints_s1 AS upper_rollingpivotpoints_s1,
    upper_data.starc_upper AS upper_starc_upper,
    upper_data.starc_lower AS upper_starc_lower,
    upper_data.standarddeviationchannels_upper AS upper_standarddeviationchannels_upper,
    upper_data.standarddeviationchannels_lower AS upper_standarddeviationchannels_lower,
    upper_data.awesomeoscillator AS upper_awesomeoscillator,
    upper_data.cci AS upper_cci,
    upper_data.connorsrsi AS upper_connorsrsi,
    upper_data.dpo AS upper_dpo,
    upper_data.rsi AS upper_rsi,
    upper_data.stc AS upper_stc,
    upper_data.smi AS upper_smi,
    upper_data.stochasticoscillator_k AS upper_stochasticoscillator_k,
    upper_data.stochasticoscillator_d AS upper_stochasticoscillator_d,
    upper_data.stochasticrsi_rsi AS upper_stochasticrsi_rsi,
    upper_data.stochasticrsi_signal AS upper_stochasticrsi_signal,
    upper_data.trix AS upper_trix,
    upper_data.ultimateoscillator AS upper_ultimateoscillator,
    upper_data.williamsr AS upper_williamsr,
    upper_data.chandelierexit AS upper_chandelierexit,
    upper_data.parabolicsar AS upper_parabolicsar,
    upper_data.volatilitystop AS upper_volatilitystop,
    upper_data.williamsfractal_bull AS upper_williamsfractal_bull,
    upper_data.williamsfractal_bear AS upper_williamsfractal_bear,
    upper_data.adl AS upper_adl,
    upper_data.cmf AS upper_cmf,
    upper_data.chaikinoscillator AS upper_chaikinoscillator,
    upper_data.forceindex AS upper_forceindex,
    upper_data.kvo AS upper_kvo,
    upper_data.mfi AS upper_mfi,
    upper_data.obv AS upper_obv,
    upper_data.pvo AS upper_pvo,
    upper_data.alma AS upper_alma,
    upper_data.dema AS upper_dema,
    upper_data.epma AS upper_epma,
    upper_data.ema5 AS upper_ema5,
    upper_data.ema9 AS upper_ema9,
    upper_data.ema13 AS upper_ema13,
    upper_data.ema50 AS upper_ema50,
    upper_data.hilberttransform AS upper_hilberttransform,
    upper_data.hma AS upper_hma,
    upper_data.kama AS upper_kama,
    upper_data.mama AS upper_mama,
    upper_data.fama AS upper_fama,
    upper_data.sma AS upper_sma,
    upper_data.smma AS upper_smma,
    upper_data.t3 AS upper_t3,
    upper_data.tema AS upper_tema,
    upper_data.vwap AS upper_vwap,
    upper_data.vwma AS upper_vwma,
    upper_data.wma AS upper_wma,
    upper_data.fishertransform_fisher AS upper_fishertransform_fisher,
    upper_data.fishertransform_trigger AS upper_fishertransform_trigger,
    upper_data.zigzag AS upper_zigzag,
    upper_data.atr AS upper_atr,
    upper_data.bop AS upper_bop,
    upper_data.choppinessindex AS upper_choppinessindex,
    upper_data.pmo AS upper_pmo,
    upper_data.pmo_signal AS upper_pmo_signal,
    upper_data.roc AS upper_roc,
    upper_data.truerange AS upper_truerange,
    upper_data.tsi AS upper_tsi,
    upper_data.ulcerindex AS upper_ulcerindex,
    upper_data.slope AS upper_slope,
    upper_data.standarddeviation AS upper_standarddeviation,

    -- Lateral join for previous ONE_DAY candle (modified from THREE_MINUTE with full indicators)
    lower_data.open AS lower_open,
    lower_data.high AS lower_high,
    lower_data.low AS lower_low,
    lower_data.close AS lower_close,
    lower_data.volume AS lower_volume,
    lower_data.aroon_up AS lower_aroon_up,
    lower_data.aroon_down AS lower_aroon_down,
    lower_data.adx AS lower_adx,
    lower_data.pdi AS lower_pdi,
    lower_data.mdi AS lower_mdi,
    lower_data.elderray_bull_power AS lower_elderray_bull_power,
    lower_data.elderray_bear_power AS lower_elderray_bear_power,
    lower_data.gator_upper AS lower_gator_upper,
    lower_data.gator_lower AS lower_gator_lower,
    lower_data.gator_is_upper_expanding AS lower_gator_is_upper_expanding,
    lower_data.gator_is_lower_expanding AS lower_gator_is_lower_expanding,
    lower_data.hurst AS lower_hurst,
    lower_data.ichimoku_tenkan_sen AS lower_ichimoku_tenkan_sen,
    lower_data.ichimoku_kijun_sen AS lower_ichimoku_kijun_sen,
    lower_data.ichimoku_senkou_span_a AS lower_ichimoku_senkou_span_a,
    lower_data.ichimoku_senkou_span_b AS lower_ichimoku_senkou_span_b,
    lower_data.ichimoku_chikou_span AS lower_ichimoku_chikou_span,
    lower_data.macd AS lower_macd,
    lower_data.macd_signal AS lower_macd_signal,
    lower_data.macd_histogram AS lower_macd_histogram,
    lower_data.supertrend AS lower_supertrend,
    lower_data.vortex_pvi AS lower_vortex_pvi,
    lower_data.vortex_nvi AS lower_vortex_nvi,
    lower_data.alligator_jaw AS lower_alligator_jaw,
    lower_data.alligator_teeth AS lower_alligator_teeth,
    lower_data.alligator_lips AS lower_alligator_lips,
    lower_data.bollingerbands_upper AS lower_bollingerbands_upper,
    lower_data.bollingerbands_lower AS lower_bollingerbands_lower,
    lower_data.donchianchannels_upper AS lower_donchianchannels_upper,
    lower_data.donchianchannels_lower AS lower_donchianchannels_lower,
    lower_data.fcb_upper AS lower_fcb_upper,
    lower_data.fcb_lower AS lower_fcb_lower,
    lower_data.keltnerchannels_upper AS lower_keltnerchannels_upper,
    lower_data.keltnerchannels_lower AS lower_keltnerchannels_lower,
    lower_data.keltnerchannels_center AS lower_keltnerchannels_center,
    lower_data.maenvelopes_upper AS lower_maenvelopes_upper,
    lower_data.maenvelopes_lower AS lower_maenvelopes_lower,
    lower_data.pivotpoints_pp AS lower_pivotpoints_pp,
    lower_data.pivotpoints_r1 AS lower_pivotpoints_r1,
    lower_data.pivotpoints_s1 AS lower_pivotpoints_s1,
    lower_data.rollingpivotpoints_pp AS lower_rollingpivotpoints_pp,
    lower_data.rollingpivotpoints_r1 AS lower_rollingpivotpoints_r1,
    lower_data.rollingpivotpoints_s1 AS lower_rollingpivotpoints_s1,
    lower_data.starc_upper AS lower_starc_upper,
    lower_data.starc_lower AS lower_starc_lower,
    lower_data.standarddeviationchannels_upper AS lower_standarddeviationchannels_upper,
    lower_data.standarddeviationchannels_lower AS lower_standarddeviationchannels_lower,
    lower_data.awesomeoscillator AS lower_awesomeoscillator,
    lower_data.cci AS lower_cci,
    lower_data.connorsrsi AS lower_connorsrsi,
    lower_data.dpo AS lower_dpo,
    lower_data.rsi AS lower_rsi,
    lower_data.stc AS lower_stc,
    lower_data.smi AS lower_smi,
    lower_data.stochasticoscillator_k AS lower_stochasticoscillator_k,
    lower_data.stochasticoscillator_d AS lower_stochasticoscillator_d,
    lower_data.stochasticrsi_rsi AS lower_stochasticrsi_rsi,
    lower_data.stochasticrsi_signal AS lower_stochasticrsi_signal,
    lower_data.trix AS lower_trix,
    lower_data.ultimateoscillator AS lower_ultimateoscillator,
    lower_data.williamsr AS lower_williamsr,
    lower_data.chandelierexit AS lower_chandelierexit,
    lower_data.parabolicsar AS lower_parabolicsar,
    lower_data.volatilitystop AS lower_volatilitystop,
    lower_data.williamsfractal_bull AS lower_williamsfractal_bull,
    lower_data.williamsfractal_bear AS lower_williamsfractal_bear,
    lower_data.adl AS lower_adl,
    lower_data.cmf AS lower_cmf,
    lower_data.chaikinoscillator AS lower_chaikinoscillator,
    lower_data.forceindex AS lower_forceindex,
    lower_data.kvo AS lower_kvo,
    lower_data.mfi AS lower_mfi,
    lower_data.obv AS lower_obv,
    lower_data.pvo AS lower_pvo,
    lower_data.alma AS lower_alma,
    lower_data.dema AS lower_dema,
    lower_data.epma AS lower_epma,
    lower_data.ema5 AS lower_ema5,
    lower_data.ema9 AS lower_ema9,
    lower_data.ema13 AS lower_ema13,
    lower_data.ema50 AS lower_ema50,
    lower_data.hilberttransform AS lower_hilberttransform,
    lower_data.hma AS lower_hma,
    lower_data.kama AS lower_kama,
    lower_data.mama AS lower_mama,
    lower_data.fama AS lower_fama,
    lower_data.sma AS lower_sma,
    lower_data.smma AS lower_smma,
    lower_data.t3 AS lower_t3,
    lower_data.tema AS lower_tema,
    lower_data.vwap AS lower_vwap,
    lower_data.vwma AS lower_vwma,
    lower_data.wma AS lower_wma,
    lower_data.fishertransform_fisher AS lower_fishertransform_fisher,
    lower_data.fishertransform_trigger AS lower_fishertransform_trigger,
    lower_data.zigzag AS lower_zigzag,
    lower_data.atr AS lower_atr,
    lower_data.bop AS lower_bop,
    lower_data.choppinessindex AS lower_choppinessindex,
    lower_data.pmo AS lower_pmo,
    lower_data.pmo_signal AS lower_pmo_signal,
    lower_data.roc AS lower_roc,
    lower_data.truerange AS lower_truerange,
    lower_data.tsi AS lower_tsi,
    lower_data.ulcerindex AS lower_ulcerindex,
    lower_data.slope AS lower_slope,
    lower_data.standarddeviation AS lower_standarddeviation

FROM base_data b
LEFT JOIN nifty_data n
  ON b.base_interval = n.nifty_interval
 AND b.base_datetime = n.nifty_datetime
LEFT JOIN LATERAL (
    SELECT
        c.open,
        c.high,
        c.low,
        c.close,
        c.volume,
        a.aroon_up,
        a.aroon_down,
        a.adx,
        a.pdi,
        a.mdi,
        a.elderray_bull_power,
        a.elderray_bear_power,
        a.gator_upper,
        a.gator_lower,
        a.gator_is_upper_expanding,
        a.gator_is_lower_expanding,
        a.hurst,
        a.ichimoku_tenkan_sen,
        a.ichimoku_kijun_sen,
        a.ichimoku_senkou_span_a,
        a.ichimoku_senkou_span_b,
        a.ichimoku_chikou_span,
        a.macd,
        a.macd_signal,
        a.macd_histogram,
        a.supertrend,
        a.vortex_pvi,
        a.vortex_nvi,
        a.alligator_jaw,
        a.alligator_teeth,
        a.alligator_lips,
        a.bollingerbands_upper,
        a.bollingerbands_lower,
        a.donchianchannels_upper,
        a.donchianchannels_lower,
        a.fcb_upper,
        a.fcb_lower,
        a.keltnerchannels_upper,
        a.keltnerchannels_lower,
        a.keltnerchannels_center,
        a.maenvelopes_upper,
        a.maenvelopes_lower,
        a.pivotpoints_pp,
        a.pivotpoints_r1,
        a.pivotpoints_s1,
        a.rollingpivotpoints_pp,
        a.rollingpivotpoints_r1,
        a.rollingpivotpoints_s1,
        a.starc_upper,
        a.starc_lower,
        a.standarddeviationchannels_upper,
        a.standarddeviationchannels_lower,
        a.awesomeoscillator,
        a.cci,
        a.connorsrsi,
        a.dpo,
        a.rsi,
        a.stc,
        a.smi,
        a.stochasticoscillator_k,
        a.stochasticoscillator_d,
        a.stochasticrsi_rsi,
        a.stochasticrsi_signal,
        a.trix,
        a.ultimateoscillator,
        a.williamsr,
        a.chandelierexit,
        a.parabolicsar,
        a.volatilitystop,
        a.williamsfractal_bull,
        a.williamsfractal_bear,
        a.adl,
        a.cmf,
        a.chaikinoscillator,
        a.forceindex,
        a.kvo,
        a.mfi,
        a.obv,
        a.pvo,
        a.alma,
        a.dema,
        a.epma,
        a.ema5,
        a.ema9,
        a.ema13,
        a.ema50,
        a.hilberttransform,
        a.hma,
        a.kama,
        a.mama,
        a.fama,
        a.sma,
        a.smma,
        a.t3,
        a.tema,
        a.vwap,
        a.vwma,
        a.wma,
        a.fishertransform_fisher,
        a.fishertransform_trigger,
        a.zigzag,
        a.atr,
        a.bop,
        a.choppinessindex,
        a.pmo,
        a.pmo_signal,
        a.roc,
        a.truerange,
        a.tsi,
        a.ulcerindex,
        a.slope,
        a.standarddeviation
    FROM candle_data c
    JOIN all_indicators_data a
      ON c.symbol = a.symbol
     AND c.interval = a.interval
     AND c.datetime = a.datetime
    WHERE c.symbol = b.base_symbol
      AND c.interval = 'ONE_MONTH'
      AND date_trunc('month', c.datetime) < date_trunc('month', b.base_datetime)
    ORDER BY c.datetime DESC
    LIMIT 1
) upper_data ON TRUE
LEFT JOIN LATERAL (
    SELECT
        c.open,
        c.high,
        c.low,
        c.close,
        c.volume,
        a.aroon_up,
        a.aroon_down,
        a.adx,
        a.pdi,
        a.mdi,
        a.elderray_bull_power,
        a.elderray_bear_power,
        a.gator_upper,
        a.gator_lower,
        a.gator_is_upper_expanding,
        a.gator_is_lower_expanding,
        a.hurst,
        a.ichimoku_tenkan_sen,
        a.ichimoku_kijun_sen,
        a.ichimoku_senkou_span_a,
        a.ichimoku_senkou_span_b,
        a.ichimoku_chikou_span,
        a.macd,
        a.macd_signal,
        a.macd_histogram,
        a.supertrend,
        a.vortex_pvi,
        a.vortex_nvi,
        a.alligator_jaw,
        a.alligator_teeth,
        a.alligator_lips,
        a.bollingerbands_upper,
        a.bollingerbands_lower,
        a.donchianchannels_upper,
        a.donchianchannels_lower,
        a.fcb_upper,
        a.fcb_lower,
        a.keltnerchannels_upper,
        a.keltnerchannels_lower,
        a.keltnerchannels_center,
        a.maenvelopes_upper,
        a.maenvelopes_lower,
        a.pivotpoints_pp,
        a.pivotpoints_r1,
        a.pivotpoints_s1,
        a.rollingpivotpoints_pp,
        a.rollingpivotpoints_r1,
        a.rollingpivotpoints_s1,
        a.starc_upper,
        a.starc_lower,
        a.standarddeviationchannels_upper,
        a.standarddeviationchannels_lower,
        a.awesomeoscillator,
        a.cci,
        a.connorsrsi,
        a.dpo,
        a.rsi,
        a.stc,
        a.smi,
        a.stochasticoscillator_k,
        a.stochasticoscillator_d,
        a.stochasticrsi_rsi,
        a.stochasticrsi_signal,
        a.trix,
        a.ultimateoscillator,
        a.williamsr,
        a.chandelierexit,
        a.parabolicsar,
        a.volatilitystop,
        a.williamsfractal_bull,
        a.williamsfractal_bear,
        a.adl,
        a.cmf,
        a.chaikinoscillator,
        a.forceindex,
        a.kvo,
        a.mfi,
        a.obv,
        a.pvo,
        a.alma,
        a.dema,
        a.epma,
        a.ema5,
        a.ema9,
        a.ema13,
        a.ema50,
        a.hilberttransform,
        a.hma,
        a.kama,
        a.mama,
        a.fama,
        a.sma,
        a.smma,
        a.t3,
        a.tema,
        a.vwap,
        a.vwma,
        a.wma,
        a.fishertransform_fisher,
        a.fishertransform_trigger,
        a.zigzag,
        a.atr,
        a.bop,
        a.choppinessindex,
        a.pmo,
        a.pmo_signal,
        a.roc,
        a.truerange,
        a.tsi,
        a.ulcerindex,
        a.slope,
        a.standarddeviation
    FROM candle_data c
    JOIN all_indicators_data a
      ON c.symbol = a.symbol
     AND c.interval = a.interval
     AND c.datetime = a.datetime
    WHERE c.symbol = b.base_symbol
      AND c.interval = 'ONE_DAY'
      AND c.datetime >= b.base_datetime
      AND c.datetime < b.base_datetime + INTERVAL '1 week'
    ORDER BY c.datetime DESC
    LIMIT 1
) lower_data ON TRUE

ORDER BY
    b.base_symbol,
    b.base_interval,
    b.base_datetime;
