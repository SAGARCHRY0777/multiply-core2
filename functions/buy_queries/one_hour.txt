WITH filter_data AS (
    SELECT
        UNNEST(%(symbols_list)s::TEXT[]) AS symbol,
        UNNEST(%(intervals_list)s::TEXT[]) AS interval,
        UNNEST(%(datetime_list)s::TIMESTAMPTZ[]) AS datetime
),
base_data AS (
    SELECT
        c.symbol AS base_symbol,
        c.interval AS base_interval,
        c.datetime AS base_datetime,
        c.open AS base_open,
        c.high AS base_high,
        c.low AS base_low,
        c.close AS base_close,
        c.volume AS base_volume,
        a.*
    FROM candle_data c
    JOIN all_indicators_data a
      ON c.symbol = a.symbol
     AND c.interval = a.interval
     AND c.datetime = a.datetime
    WHERE (c.symbol, c.interval, c.datetime) IN (
          SELECT symbol, interval, datetime FROM filter_data
    )
),
nifty_data AS (
    SELECT
        c.symbol AS nifty_symbol,
        c.interval AS nifty_interval,
        c.datetime AS nifty_datetime,
        c.open AS nifty_open,
        c.high AS nifty_high,
        c.low AS nifty_low,
        c.close AS nifty_close,
        a.*
    FROM candle_data c
    JOIN all_indicators_data a
      ON c.symbol = a.symbol
     AND c.interval = a.interval
     AND c.datetime = a.datetime
    WHERE c.symbol = 'NIFTY'
      AND (c.interval, c.datetime) IN (
          SELECT interval, datetime FROM filter_data
    )
)
SELECT
    -- Base data and its indicators
    b.base_symbol,
    b.base_interval,
    b.base_datetime,
    b.base_open,
    b.base_high,
    b.base_low,
    b.base_close,
    b.base_volume,
    b.aroon_up            AS base_aroon_up,
    b.aroon_down          AS base_aroon_down,
    b.adx                 AS base_adx,
    b.pdi                 AS base_pdi,
    b.mdi                 AS base_mdi,
    b.elderray_bull_power AS base_elderray_bull_power,
    b.elderray_bear_power AS base_elderray_bear_power,
    b.gator_upper         AS base_gator_upper,
    b.gator_lower         AS base_gator_lower,
    b.gator_is_upper_expanding AS base_gator_is_upper_expanding,
    b.gator_is_lower_expanding AS base_gator_is_lower_expanding,
    b.hurst               AS base_hurst,
    b.ichimoku_tenkan_sen AS base_ichimoku_tenkan_sen,
    b.ichimoku_kijun_sen  AS base_ichimoku_kijun_sen,
    b.ichimoku_senkou_span_a AS base_ichimoku_senkou_span_a,
    b.ichimoku_senkou_span_b AS base_ichimoku_senkou_span_b,
    b.ichimoku_chikou_span    AS base_ichimoku_chikou_span,
    b.macd                AS base_macd,
    b.macd_signal         AS base_macd_signal,
    b.macd_histogram      AS base_macd_histogram,
    b.supertrend          AS base_supertrend,
    b.vortex_pvi          AS base_vortex_pvi,
    b.vortex_nvi          AS base_vortex_nvi,
    b.alligator_jaw       AS base_alligator_jaw,
    b.alligator_teeth     AS base_alligator_teeth,
    b.alligator_lips      AS base_alligator_lips,
    b.bollingerbands_upper AS base_bollingerbands_upper,
    b.bollingerbands_lower AS base_bollingerbands_lower,
    b.donchianchannels_upper AS base_donchianchannels_upper,
    b.donchianchannels_lower AS base_donchianchannels_lower,
    b.fcb_upper           AS base_fcb_upper,
    b.fcb_lower           AS base_fcb_lower,
    b.keltnerchannels_upper  AS base_keltnerchannels_upper,
    b.keltnerchannels_lower  AS base_keltnerchannels_lower,
    b.keltnerchannels_center AS base_keltnerchannels_center,
    b.maenvelopes_upper   AS base_maenvelopes_upper,
    b.maenvelopes_lower   AS base_maenvelopes_lower,
    b.pivotpoints_pp      AS base_pivotpoints_pp,
    b.pivotpoints_r1      AS base_pivotpoints_r1,
    b.pivotpoints_s1      AS base_pivotpoints_s1,
    b.rollingpivotpoints_pp AS base_rollingpivotpoints_pp,
    b.rollingpivotpoints_r1 AS base_rollingpivotpoints_r1,
    b.rollingpivotpoints_s1 AS base_rollingpivotpoints_s1,
    b.starc_upper         AS base_starc_upper,
    b.starc_lower         AS base_starc_lower,
    b.standarddeviationchannels_upper AS base_standarddeviationchannels_upper,
    b.standarddeviationchannels_lower AS base_standarddeviationchannels_lower,
    b.awesomeoscillator   AS base_awesomeoscillator,
    b.cci                 AS base_cci,
    b.connorsrsi          AS base_connorsrsi,
    b.dpo                 AS base_dpo,
    b.rsi                 AS base_rsi,
    b.stc                 AS base_stc,
    b.smi                 AS base_smi,
    b.stochasticoscillator_k AS base_stochasticoscillator_k,
    b.stochasticoscillator_d AS base_stochasticoscillator_d,
    b.stochasticrsi_rsi   AS base_stochasticrsi_rsi,
    b.stochasticrsi_signal AS base_stochasticrsi_signal,
    b.trix                AS base_trix,
    b.ultimateoscillator  AS base_ultimateoscillator,
    b.williamsr           AS base_williamsr,
    b.chandelierexit      AS base_chandelierexit,
    b.parabolicsar        AS base_parabolicsar,
    b.volatilitystop      AS base_volatilitystop,
    b.williamsfractal_bull AS base_williamsfractal_bull,
    b.williamsfractal_bear AS base_williamsfractal_bear,
    b.adl                 AS base_adl,
    b.cmf                 AS base_cmf,
    b.chaikinoscillator   AS base_chaikinoscillator,
    b.forceindex          AS base_forceindex,
    b.kvo                 AS base_kvo,
    b.mfi                 AS base_mfi,
    b.obv                 AS base_obv,
    b.pvo                 AS base_pvo,
    b.alma                AS base_alma,
    b.dema                AS base_dema,
    b.epma                AS base_epma,
    b.ema5                AS base_ema5,
    b.ema9                AS base_ema9,
    b.ema13               AS base_ema13,
    b.ema50               AS base_ema50,
    b.hilberttransform    AS base_hilberttransform,
    b.hma                 AS base_hma,
    b.kama                AS base_kama,
    b.mama                AS base_mama,
    b.fama                AS base_fama,
    b.sma                 AS base_sma,
    b.smma                AS base_smma,
    b.t3                  AS base_t3,
    b.tema                AS base_tema,
    b.vwap                AS base_vwap,
    b.vwma                AS base_vwma,
    b.wma                 AS base_wma,
    b.fishertransform_fisher AS base_fishertransform_fisher,
    b.fishertransform_trigger AS base_fishertransform_trigger,
    b.zigzag              AS base_zigzag,
    b.atr                 AS base_atr,
    b.bop                 AS base_bop,
    b.choppinessindex     AS base_choppinessindex,
    b.pmo                 AS base_pmo,
    b.pmo_signal          AS base_pmo_signal,
    b.roc                 AS base_roc,
    b.truerange           AS base_truerange,
    b.tsi                 AS base_tsi,
    b.ulcerindex          AS base_ulcerindex,
    b.slope               AS base_slope,
    b.standarddeviation   AS base_standarddeviation,

    -- Nifty data for reference
    n.nifty_open,
    n.nifty_high,
    n.nifty_low,
    n.nifty_close,
    n.aroon_up           AS nifty_aroon_up,
    n.aroon_down         AS nifty_aroon_down,
    n.adx                AS nifty_adx,
    n.pdi                AS nifty_pdi,
    n.mdi                AS nifty_mdi,
    n.elderray_bull_power AS nifty_elderray_bull_power,
    n.elderray_bear_power AS nifty_elderray_bear_power,
    n.gator_upper        AS nifty_gator_upper,
    n.gator_lower        AS nifty_gator_lower,
    n.gator_is_upper_expanding AS nifty_gator_is_upper_expanding,
    n.gator_is_lower_expanding AS nifty_gator_is_lower_expanding,
    n.hurst              AS nifty_hurst,
    n.ichimoku_tenkan_sen AS nifty_ichimoku_tenkan_sen,
    n.ichimoku_kijun_sen AS nifty_ichimoku_kijun_sen,
    n.ichimoku_senkou_span_a AS nifty_ichimoku_senkou_span_a,
    n.ichimoku_senkou_span_b AS nifty_ichimoku_senkou_span_b,
    n.ichimoku_chikou_span   AS nifty_ichimoku_chikou_span,
    n.macd               AS nifty_macd,
    n.macd_signal        AS nifty_macd_signal,
    n.macd_histogram     AS nifty_macd_histogram,
    n.supertrend         AS nifty_supertrend,
    n.vortex_pvi         AS nifty_vortex_pvi,
    n.vortex_nvi         AS nifty_vortex_nvi,
    n.alligator_jaw      AS nifty_alligator_jaw,
    n.alligator_teeth    AS nifty_alligator_teeth,
    n.alligator_lips     AS nifty_alligator_lips,
    n.bollingerbands_upper AS nifty_bollingerbands_upper,
    n.bollingerbands_lower AS nifty_bollingerbands_lower,
    n.donchianchannels_upper AS nifty_donchianchannels_upper,
    n.donchianchannels_lower AS nifty_donchianchannels_lower,
    n.fcb_upper          AS nifty_fcb_upper,
    n.fcb_lower          AS nifty_fcb_lower,
    n.keltnerchannels_upper AS nifty_keltnerchannels_upper,
    n.keltnerchannels_lower AS nifty_keltnerchannels_lower,
    n.keltnerchannels_center AS nifty_keltnerchannels_center,
    n.maenvelopes_upper  AS nifty_maenvelopes_upper,
    n.maenvelopes_lower  AS nifty_maenvelopes_lower,
    n.pivotpoints_pp     AS nifty_pivotpoints_pp,
    n.pivotpoints_r1     AS nifty_pivotpoints_r1,
    n.pivotpoints_s1     AS nifty_pivotpoints_s1,
    n.rollingpivotpoints_pp AS nifty_rollingpivotpoints_pp,
    n.rollingpivotpoints_r1 AS nifty_rollingpivotpoints_r1,
    n.rollingpivotpoints_s1 AS nifty_rollingpivotpoints_s1,
    n.starc_upper        AS nifty_starc_upper,
    n.starc_lower        AS nifty_starc_lower,
    n.standarddeviationchannels_upper AS nifty_standarddeviationchannels_upper,
    n.standarddeviationchannels_lower AS nifty_standarddeviationchannels_lower,
    n.awesomeoscillator  AS nifty_awesomeoscillator,
    n.cci                AS nifty_cci,
    n.connorsrsi         AS nifty_connorsrsi,
    n.dpo                AS nifty_dpo,
    n.rsi                AS nifty_rsi,
    n.stc                AS nifty_stc,
    n.smi                AS nifty_smi,
    n.stochasticoscillator_k AS nifty_stochasticoscillator_k,
    n.stochasticoscillator_d AS nifty_stochasticoscillator_d,
    n.stochasticrsi_rsi   AS nifty_stochasticrsi_rsi,
    n.stochasticrsi_signal AS nifty_stochasticrsi_signal,
    n.trix               AS nifty_trix,
    n.ultimateoscillator AS nifty_ultimateoscillator,
    n.williamsr          AS nifty_williamsr,
    n.chandelierexit     AS nifty_chandelierexit,
    n.parabolicsar       AS nifty_parabolicsar,
    n.volatilitystop     AS nifty_volatilitystop,
    n.williamsfractal_bull AS nifty_williamsfractal_bull,
    n.williamsfractal_bear AS nifty_williamsfractal_bear,
    n.adl                AS nifty_adl,
    n.cmf                AS nifty_cmf,
    n.chaikinoscillator  AS nifty_chaikinoscillator,
    n.forceindex         AS nifty_forceindex,
    n.kvo                AS nifty_kvo,
    n.mfi                AS nifty_mfi,
    n.obv                AS nifty_obv,
    n.pvo                AS nifty_pvo,
    n.alma               AS nifty_alma,
    n.dema               AS nifty_dema,
    n.epma               AS nifty_epma,
    n.ema5               AS nifty_ema5,
    n.ema9               AS nifty_ema9,
    n.ema13              AS nifty_ema13,
    n.ema50              AS nifty_ema50,
    n.hilberttransform   AS nifty_hilberttransform,
    n.hma                AS nifty_hma,
    n.kama               AS nifty_kama,
    n.mama               AS nifty_mama,
    n.fama               AS nifty_fama,
    n.sma                AS nifty_sma,
    n.smma               AS nifty_smma,
    n.t3                 AS nifty_t3,
    n.tema               AS nifty_tema,
    n.vwap               AS nifty_vwap,
    n.vwma               AS nifty_vwma,
    n.wma                AS nifty_wma,
    n.fishertransform_fisher AS nifty_fishertransform_fisher,
    n.fishertransform_trigger AS nifty_fishertransform_trigger,
    n.zigzag             AS nifty_zigzag,
    n.atr                AS nifty_atr,
    n.bop                AS nifty_bop,
    n.choppinessindex    AS nifty_choppinessindex,
    n.pmo                AS nifty_pmo,
    n.pmo_signal         AS nifty_pmo_signal,
    n.roc                AS nifty_roc,
    n.truerange          AS nifty_truerange,
    n.tsi                AS nifty_tsi,
    n.ulcerindex         AS nifty_ulcerindex,
    n.slope              AS nifty_slope,
    n.standarddeviation  AS nifty_standarddeviation,

    -- Lateral join for previous ONE_DAY candle (was ONE_HOUR)
    upper_data.upper_open,
    upper_data.upper_high,
    upper_data.upper_low,
    upper_data.upper_close,
    upper_data.upper_volume,
    upper_data.upper_aroon_up,
    upper_data.upper_aroon_down,
    upper_data.upper_adx,
    upper_data.upper_pdi,
    upper_data.upper_mdi,
    upper_data.upper_elderray_bull_power,
    upper_data.upper_elderray_bear_power,
    upper_data.upper_gator_upper,
    upper_data.upper_gator_lower,
    upper_data.upper_gator_is_upper_expanding,
    upper_data.upper_gator_is_lower_expanding,
    upper_data.upper_hurst,
    upper_data.upper_ichimoku_tenkan_sen,
    upper_data.upper_ichimoku_kijun_sen,
    upper_data.upper_ichimoku_senkou_span_a,
    upper_data.upper_ichimoku_senkou_span_b,
    upper_data.upper_ichimoku_chikou_span,
    upper_data.upper_macd,
    upper_data.upper_macd_signal,
    upper_data.upper_macd_histogram,
    upper_data.upper_supertrend,
    upper_data.upper_vortex_pvi,
    upper_data.upper_vortex_nvi,
    upper_data.upper_alligator_jaw,
    upper_data.upper_alligator_teeth,
    upper_data.upper_alligator_lips,
    upper_data.upper_bollingerbands_upper,
    upper_data.upper_bollingerbands_lower,
    upper_data.upper_donchianchannels_upper,
    upper_data.upper_donchianchannels_lower,
    upper_data.upper_fcb_upper,
    upper_data.upper_fcb_lower,
    upper_data.upper_keltnerchannels_upper,
    upper_data.upper_keltnerchannels_lower,
    upper_data.upper_keltnerchannels_center,
    upper_data.upper_maenvelopes_upper,
    upper_data.upper_maenvelopes_lower,
    upper_data.upper_pivotpoints_pp,
    upper_data.upper_pivotpoints_r1,
    upper_data.upper_pivotpoints_s1,
    upper_data.upper_rollingpivotpoints_pp,
    upper_data.upper_rollingpivotpoints_r1,
    upper_data.upper_rollingpivotpoints_s1,
    upper_data.upper_starc_upper,
    upper_data.upper_starc_lower,
    upper_data.upper_standarddeviationchannels_upper,
    upper_data.upper_standarddeviationchannels_lower,
    upper_data.upper_awesomeoscillator,
    upper_data.upper_cci,
    upper_data.upper_connorsrsi,
    upper_data.upper_dpo,
    upper_data.upper_rsi,
    upper_data.upper_stc,
    upper_data.upper_smi,
    upper_data.upper_stochasticoscillator_k,
    upper_data.upper_stochasticoscillator_d,
    upper_data.upper_stochasticrsi_rsi,
    upper_data.upper_stochasticrsi_signal,
    upper_data.upper_trix,
    upper_data.upper_ultimateoscillator,
    upper_data.upper_williamsr,
    upper_data.upper_chandelierexit,
    upper_data.upper_parabolicsar,
    upper_data.upper_volatilitystop,
    upper_data.upper_williamsfractal_bull,
    upper_data.upper_williamsfractal_bear,
    upper_data.upper_adl,
    upper_data.upper_cmf,
    upper_data.upper_chaikinoscillator,
    upper_data.upper_forceindex,
    upper_data.upper_kvo,
    upper_data.upper_mfi,
    upper_data.upper_obv,
    upper_data.upper_pvo,
    upper_data.upper_alma,
    upper_data.upper_dema,
    upper_data.upper_epma,
    upper_data.upper_ema5,
    upper_data.upper_ema9,
    upper_data.upper_ema13,
    upper_data.upper_ema50,
    upper_data.upper_hilberttransform,
    upper_data.upper_hma,
    upper_data.upper_kama,
    upper_data.upper_mama,
    upper_data.upper_fama,
    upper_data.upper_sma,
    upper_data.upper_smma,
    upper_data.upper_t3,
    upper_data.upper_tema,
    upper_data.upper_vwap,
    upper_data.upper_vwma,
    upper_data.upper_wma,
    upper_data.upper_fishertransform_fisher,
    upper_data.upper_fishertransform_trigger,
    upper_data.upper_zigzag,
    upper_data.upper_atr,
    upper_data.upper_bop,
    upper_data.upper_choppinessindex,
    upper_data.upper_pmo,
    upper_data.upper_pmo_signal,
    upper_data.upper_roc,
    upper_data.upper_truerange,
    upper_data.upper_tsi,
    upper_data.upper_ulcerindex,
    upper_data.upper_slope,
    upper_data.upper_standarddeviation,

    -- Lateral join for previous ONE_WEEK candle (was ONE_DAY)
    super_data.super_open,
    super_data.super_high,
    super_data.super_low,
    super_data.super_close,
    super_data.super_volume,
    super_data.super_aroon_up,
    super_data.super_aroon_down,
    super_data.super_adx,
    super_data.super_pdi,
    super_data.super_mdi,
    super_data.super_elderray_bull_power,
    super_data.super_elderray_bear_power,
    super_data.super_gator_upper,
    super_data.super_gator_lower,
    super_data.super_gator_is_upper_expanding,
    super_data.super_gator_is_lower_expanding,
    super_data.super_hurst,
    super_data.super_ichimoku_tenkan_sen,
    super_data.super_ichimoku_kijun_sen,
    super_data.super_ichimoku_senkou_span_a,
    super_data.super_ichimoku_senkou_span_b,
    super_data.super_ichimoku_chikou_span,
    super_data.super_macd,
    super_data.super_macd_signal,
    super_data.super_macd_histogram,
    super_data.super_supertrend,
    super_data.super_vortex_pvi,
    super_data.super_vortex_nvi,
    super_data.super_alligator_jaw,
    super_data.super_alligator_teeth,
    super_data.super_alligator_lips,
    super_data.super_bollingerbands_upper,
    super_data.super_bollingerbands_lower,
    super_data.super_donchianchannels_upper,
    super_data.super_donchianchannels_lower,
    super_data.super_fcb_upper,
    super_data.super_fcb_lower,
    super_data.super_keltnerchannels_upper,
    super_data.super_keltnerchannels_lower,
    super_data.super_keltnerchannels_center,
    super_data.super_maenvelopes_upper,
    super_data.super_maenvelopes_lower,
    super_data.super_pivotpoints_pp,
    super_data.super_pivotpoints_r1,
    super_data.super_pivotpoints_s1,
    super_data.super_rollingpivotpoints_pp,
    super_data.super_rollingpivotpoints_r1,
    super_data.super_rollingpivotpoints_s1,
    super_data.super_starc_upper,
    super_data.super_starc_lower,
    super_data.super_standarddeviationchannels_upper,
    super_data.super_standarddeviationchannels_lower,
    super_data.super_awesomeoscillator,
    super_data.super_cci,
    super_data.super_connorsrsi,
    super_data.super_dpo,
    super_data.super_rsi,
    super_data.super_stc,
    super_data.super_smi,
    super_data.super_stochasticoscillator_k,
    super_data.super_stochasticoscillator_d,
    super_data.super_stochasticrsi_rsi,
    super_data.super_stochasticrsi_signal,
    super_data.super_trix,
    super_data.super_ultimateoscillator,
    super_data.super_williamsr,
    super_data.super_chandelierexit,
    super_data.super_parabolicsar,
    super_data.super_volatilitystop,
    super_data.super_williamsfractal_bull,
    super_data.super_williamsfractal_bear,
    super_data.super_adl,
    super_data.super_cmf,
    super_data.super_chaikinoscillator,
    super_data.super_forceindex,
    super_data.super_kvo,
    super_data.super_mfi,
    super_data.super_obv,
    super_data.super_pvo,
    super_data.super_alma,
    super_data.super_dema,
    super_data.super_epma,
    super_data.super_ema5,
    super_data.super_ema9,
    super_data.super_ema13,
    super_data.super_ema50,
    super_data.super_hilberttransform,
    super_data.super_hma,
    super_data.super_kama,
    super_data.super_mama,
    super_data.super_fama,
    super_data.super_sma,
    super_data.super_smma,
    super_data.super_t3,
    super_data.super_tema,
    super_data.super_vwap,
    super_data.super_vwma,
    super_data.super_wma,
    super_data.super_fishertransform_fisher,
    super_data.super_fishertransform_trigger,
    super_data.super_zigzag,
    super_data.super_atr,
    super_data.super_bop,
    super_data.super_choppinessindex,
    super_data.super_pmo,
    super_data.super_pmo_signal,
    super_data.super_roc,
    super_data.super_truerange,
    super_data.super_tsi,
    super_data.super_ulcerindex,
    super_data.super_slope,
    super_data.super_standarddeviation,

    -- Lateral join for previous FIFTEEN_MINUTE candle (with full indicators)
    lower_data.lower_open,
    lower_data.lower_high,
    lower_data.lower_low,
    lower_data.lower_close,
    lower_data.lower_volume,
    lower_data.lower_aroon_up,
    lower_data.lower_aroon_down,
    lower_data.lower_adx,
    lower_data.lower_pdi,
    lower_data.lower_mdi,
    lower_data.lower_elderray_bull_power,
    lower_data.lower_elderray_bear_power,
    lower_data.lower_gator_upper,
    lower_data.lower_gator_lower,
    lower_data.lower_gator_is_upper_expanding,
    lower_data.lower_gator_is_lower_expanding,
    lower_data.lower_hurst,
    lower_data.lower_ichimoku_tenkan_sen,
    lower_data.lower_ichimoku_kijun_sen,
    lower_data.lower_ichimoku_senkou_span_a,
    lower_data.lower_ichimoku_senkou_span_b,
    lower_data.lower_ichimoku_chikou_span,
    lower_data.lower_macd,
    lower_data.lower_macd_signal,
    lower_data.lower_macd_histogram,
    lower_data.lower_supertrend,
    lower_data.lower_vortex_pvi,
    lower_data.lower_vortex_nvi,
    lower_data.lower_alligator_jaw,
    lower_data.lower_alligator_teeth,
    lower_data.lower_alligator_lips,
    lower_data.lower_bollingerbands_upper,
    lower_data.lower_bollingerbands_lower,
    lower_data.lower_donchianchannels_upper,
    lower_data.lower_donchianchannels_lower,
    lower_data.lower_fcb_upper,
    lower_data.lower_fcb_lower,
    lower_data.lower_keltnerchannels_upper,
    lower_data.lower_keltnerchannels_lower,
    lower_data.lower_keltnerchannels_center,
    lower_data.lower_maenvelopes_upper,
    lower_data.lower_maenvelopes_lower,
    lower_data.lower_pivotpoints_pp,
    lower_data.lower_pivotpoints_r1,
    lower_data.lower_pivotpoints_s1,
    lower_data.lower_rollingpivotpoints_pp,
    lower_data.lower_rollingpivotpoints_r1,
    lower_data.lower_rollingpivotpoints_s1,
    lower_data.lower_starc_upper,
    lower_data.lower_starc_lower,
    lower_data.lower_standarddeviationchannels_upper,
    lower_data.lower_standarddeviationchannels_lower,
    lower_data.lower_awesomeoscillator,
    lower_data.lower_cci,
    lower_data.lower_connorsrsi,
    lower_data.lower_dpo,
    lower_data.lower_rsi,
    lower_data.lower_stc,
    lower_data.lower_smi,
    lower_data.lower_stochasticoscillator_k,
    lower_data.lower_stochasticoscillator_d,
    lower_data.lower_stochasticrsi_rsi,
    lower_data.lower_stochasticrsi_signal,
    lower_data.lower_trix,
    lower_data.lower_ultimateoscillator,
    lower_data.lower_williamsr,
    lower_data.lower_chandelierexit,
    lower_data.lower_parabolicsar,
    lower_data.lower_volatilitystop,
    lower_data.lower_williamsfractal_bull,
    lower_data.lower_williamsfractal_bear,
    lower_data.lower_adl,
    lower_data.lower_cmf,
    lower_data.lower_chaikinoscillator,
    lower_data.lower_forceindex,
    lower_data.lower_kvo,
    lower_data.lower_mfi,
    lower_data.lower_obv,
    lower_data.lower_pvo,
    lower_data.lower_alma,
    lower_data.lower_dema,
    lower_data.lower_epma,
    lower_data.lower_ema5,
    lower_data.lower_ema9,
    lower_data.lower_ema13,
    lower_data.lower_ema50,
    lower_data.lower_hilberttransform,
    lower_data.lower_hma,
    lower_data.lower_kama,
    lower_data.lower_mama,
    lower_data.lower_fama,
    lower_data.lower_sma,
    lower_data.lower_smma,
    lower_data.lower_t3,
    lower_data.lower_tema,
    lower_data.lower_vwap,
    lower_data.lower_vwma,
    lower_data.lower_wma,
    lower_data.lower_fishertransform_fisher,
    lower_data.lower_fishertransform_trigger,
    lower_data.lower_zigzag,
    lower_data.lower_atr,
    lower_data.lower_bop,
    lower_data.lower_choppinessindex,
    lower_data.lower_pmo,
    lower_data.lower_pmo_signal,
    lower_data.lower_roc,
    lower_data.lower_truerange,
    lower_data.lower_tsi,
    lower_data.lower_ulcerindex,
    lower_data.lower_slope,
    lower_data.lower_standarddeviation

FROM base_data b
LEFT JOIN nifty_data n
  ON b.base_interval = n.nifty_interval
 AND b.base_datetime = n.nifty_datetime
LEFT JOIN LATERAL (
    SELECT
        c.open AS upper_open,
        c.high AS upper_high,
        c.low AS upper_low,
        c.close AS upper_close,
        c.volume AS upper_volume,
        a.aroon_up AS upper_aroon_up,
        a.aroon_down AS upper_aroon_down,
        a.adx AS upper_adx,
        a.pdi AS upper_pdi,
        a.mdi AS upper_mdi,
        a.elderray_bull_power AS upper_elderray_bull_power,
        a.elderray_bear_power AS upper_elderray_bear_power,
        a.gator_upper AS upper_gator_upper,
        a.gator_lower AS upper_gator_lower,
        a.gator_is_upper_expanding AS upper_gator_is_upper_expanding,
        a.gator_is_lower_expanding AS upper_gator_is_lower_expanding,
        a.hurst AS upper_hurst,
        a.ichimoku_tenkan_sen AS upper_ichimoku_tenkan_sen,
        a.ichimoku_kijun_sen AS upper_ichimoku_kijun_sen,
        a.ichimoku_senkou_span_a AS upper_ichimoku_senkou_span_a,
        a.ichimoku_senkou_span_b AS upper_ichimoku_senkou_span_b,
        a.ichimoku_chikou_span AS upper_ichimoku_chikou_span,
        a.macd AS upper_macd,
        a.macd_signal AS upper_macd_signal,
        a.macd_histogram AS upper_macd_histogram,
        a.supertrend AS upper_supertrend,
        a.vortex_pvi AS upper_vortex_pvi,
        a.vortex_nvi AS upper_vortex_nvi,
        a.alligator_jaw AS upper_alligator_jaw,
        a.alligator_teeth AS upper_alligator_teeth,
        a.alligator_lips AS upper_alligator_lips,
        a.bollingerbands_upper AS upper_bollingerbands_upper,
        a.bollingerbands_lower AS upper_bollingerbands_lower,
        a.donchianchannels_upper AS upper_donchianchannels_upper,
        a.donchianchannels_lower AS upper_donchianchannels_lower,
        a.fcb_upper AS upper_fcb_upper,
        a.fcb_lower AS upper_fcb_lower,
        a.keltnerchannels_upper AS upper_keltnerchannels_upper,
        a.keltnerchannels_lower AS upper_keltnerchannels_lower,
        a.keltnerchannels_center AS upper_keltnerchannels_center,
        a.maenvelopes_upper AS upper_maenvelopes_upper,
        a.maenvelopes_lower AS upper_maenvelopes_lower,
        a.pivotpoints_pp AS upper_pivotpoints_pp,
        a.pivotpoints_r1 AS upper_pivotpoints_r1,
        a.pivotpoints_s1 AS upper_pivotpoints_s1,
        a.rollingpivotpoints_pp AS upper_rollingpivotpoints_pp,
        a.rollingpivotpoints_r1 AS upper_rollingpivotpoints_r1,
        a.rollingpivotpoints_s1 AS upper_rollingpivotpoints_s1,
        a.starc_upper AS upper_starc_upper,
        a.starc_lower AS upper_starc_lower,
        a.standarddeviationchannels_upper AS upper_standarddeviationchannels_upper,
        a.standarddeviationchannels_lower AS upper_standarddeviationchannels_lower,
        a.awesomeoscillator AS upper_awesomeoscillator,
        a.cci AS upper_cci,
        a.connorsrsi AS upper_connorsrsi,
        a.dpo AS upper_dpo,
        a.rsi AS upper_rsi,
        a.stc AS upper_stc,
        a.smi AS upper_smi,
        a.stochasticoscillator_k AS upper_stochasticoscillator_k,
        a.stochasticoscillator_d AS upper_stochasticoscillator_d,
        a.stochasticrsi_rsi AS upper_stochasticrsi_rsi,
        a.stochasticrsi_signal AS upper_stochasticrsi_signal,
        a.trix AS upper_trix,
        a.ultimateoscillator AS upper_ultimateoscillator,
        a.williamsr AS upper_williamsr,
        a.chandelierexit AS upper_chandelierexit,
        a.parabolicsar AS upper_parabolicsar,
        a.volatilitystop AS upper_volatilitystop,
        a.williamsfractal_bull AS upper_williamsfractal_bull,
        a.williamsfractal_bear AS upper_williamsfractal_bear,
        a.adl AS upper_adl,
        a.cmf AS upper_cmf,
        a.chaikinoscillator AS upper_chaikinoscillator,
        a.forceindex AS upper_forceindex,
        a.kvo AS upper_kvo,
        a.mfi AS upper_mfi,
        a.obv AS upper_obv,
        a.pvo AS upper_pvo,
        a.alma AS upper_alma,
        a.dema AS upper_dema,
        a.epma AS upper_epma,
        a.ema5 AS upper_ema5,
        a.ema9 AS upper_ema9,
        a.ema13 AS upper_ema13,
        a.ema50 AS upper_ema50,
        a.hilberttransform AS upper_hilberttransform,
        a.hma AS upper_hma,
        a.kama AS upper_kama,
        a.mama AS upper_mama,
        a.fama AS upper_fama,
        a.sma AS upper_sma,
        a.smma AS upper_smma,
        a.t3 AS upper_t3,
        a.tema AS upper_tema,
        a.vwap AS upper_vwap,
        a.vwma AS upper_vwma,
        a.wma AS upper_wma,
        a.fishertransform_fisher AS upper_fishertransform_fisher,
        a.fishertransform_trigger AS upper_fishertransform_trigger,
        a.zigzag AS upper_zigzag,
        a.atr AS upper_atr,
        a.bop AS upper_bop,
        a.choppinessindex AS upper_choppinessindex,
        a.pmo AS upper_pmo,
        a.pmo_signal AS upper_pmo_signal,
        a.roc AS upper_roc,
        a.truerange AS upper_truerange,
        a.tsi AS upper_tsi,
        a.ulcerindex AS upper_ulcerindex,
        a.slope AS upper_slope,
        a.standarddeviation AS upper_standarddeviation
    FROM candle_data c
    JOIN all_indicators_data a
      ON c.symbol = a.symbol
     AND c.interval = a.interval
     AND c.datetime = a.datetime
    WHERE c.symbol = b.base_symbol
      AND c.interval = 'ONE_DAY'
      AND c.datetime < b.base_datetime
    ORDER BY c.datetime DESC
    LIMIT 1
) upper_data ON TRUE
LEFT JOIN LATERAL (
    SELECT
        c.open AS super_open,
        c.high AS super_high,
        c.low AS super_low,
        c.close AS super_close,
        c.volume AS super_volume,
        a.aroon_up AS super_aroon_up,
        a.aroon_down AS super_aroon_down,
        a.adx AS super_adx,
        a.pdi AS super_pdi,
        a.mdi AS super_mdi,
        a.elderray_bull_power AS super_elderray_bull_power,
        a.elderray_bear_power AS super_elderray_bear_power,
        a.gator_upper AS super_gator_upper,
        a.gator_lower AS super_gator_lower,
        a.gator_is_upper_expanding AS super_gator_is_upper_expanding,
        a.gator_is_lower_expanding AS super_gator_is_lower_expanding,
        a.hurst AS super_hurst,
        a.ichimoku_tenkan_sen AS super_ichimoku_tenkan_sen,
        a.ichimoku_kijun_sen AS super_ichimoku_kijun_sen,
        a.ichimoku_senkou_span_a AS super_ichimoku_senkou_span_a,
        a.ichimoku_senkou_span_b AS super_ichimoku_senkou_span_b,
        a.ichimoku_chikou_span AS super_ichimoku_chikou_span,
        a.macd AS super_macd,
        a.macd_signal AS super_macd_signal,
        a.macd_histogram AS super_macd_histogram,
        a.supertrend AS super_supertrend,
        a.vortex_pvi AS super_vortex_pvi,
        a.vortex_nvi AS super_vortex_nvi,
        a.alligator_jaw AS super_alligator_jaw,
        a.alligator_teeth AS super_alligator_teeth,
        a.alligator_lips AS super_alligator_lips,
        a.bollingerbands_upper AS super_bollingerbands_upper,
        a.bollingerbands_lower AS super_bollingerbands_lower,
        a.donchianchannels_upper AS super_donchianchannels_upper,
        a.donchianchannels_lower AS super_donchianchannels_lower,
        a.fcb_upper AS super_fcb_upper,
        a.fcb_lower AS super_fcb_lower,
        a.keltnerchannels_upper AS super_keltnerchannels_upper,
        a.keltnerchannels_lower AS super_keltnerchannels_lower,
        a.keltnerchannels_center AS super_keltnerchannels_center,
        a.maenvelopes_upper AS super_maenvelopes_upper,
        a.maenvelopes_lower AS super_maenvelopes_lower,
        a.pivotpoints_pp AS super_pivotpoints_pp,
        a.pivotpoints_r1 AS super_pivotpoints_r1,
        a.pivotpoints_s1 AS super_pivotpoints_s1,
        a.rollingpivotpoints_pp AS super_rollingpivotpoints_pp,
        a.rollingpivotpoints_r1 AS super_rollingpivotpoints_r1,
        a.rollingpivotpoints_s1 AS super_rollingpivotpoints_s1,
        a.starc_upper AS super_starc_upper,
        a.starc_lower AS super_starc_lower,
        a.standarddeviationchannels_upper AS super_standarddeviationchannels_upper,
        a.standarddeviationchannels_lower AS super_standarddeviationchannels_lower,
        a.awesomeoscillator AS super_awesomeoscillator,
        a.cci AS super_cci,
        a.connorsrsi AS super_connorsrsi,
        a.dpo AS super_dpo,
        a.rsi AS super_rsi,
        a.stc AS super_stc,
        a.smi AS super_smi,
        a.stochasticoscillator_k AS super_stochasticoscillator_k,
        a.stochasticoscillator_d AS super_stochasticoscillator_d,
        a.stochasticrsi_rsi AS super_stochasticrsi_rsi,
        a.stochasticrsi_signal AS super_stochasticrsi_signal,
        a.trix AS super_trix,
        a.ultimateoscillator AS super_ultimateoscillator,
        a.williamsr AS super_williamsr,
        a.chandelierexit AS super_chandelierexit,
        a.parabolicsar AS super_parabolicsar,
        a.volatilitystop AS super_volatilitystop,
        a.williamsfractal_bull AS super_williamsfractal_bull,
        a.williamsfractal_bear AS super_williamsfractal_bear,
        a.adl AS super_adl,
        a.cmf AS super_cmf,
        a.chaikinoscillator AS super_chaikinoscillator,
        a.forceindex AS super_forceindex,
        a.kvo AS super_kvo,
        a.mfi AS super_mfi,
        a.obv AS super_obv,
        a.pvo AS super_pvo,
        a.alma AS super_alma,
        a.dema AS super_dema,
        a.epma AS super_epma,
        a.ema5 AS super_ema5,
        a.ema9 AS super_ema9,
        a.ema13 AS super_ema13,
        a.ema50 AS super_ema50,
        a.hilberttransform AS super_hilberttransform,
        a.hma AS super_hma,
        a.kama AS super_kama,
        a.mama AS super_mama,
        a.fama AS super_fama,
        a.sma AS super_sma,
        a.smma AS super_smma,
        a.t3 AS super_t3,
        a.tema AS super_tema,
        a.vwap AS super_vwap,
        a.vwma AS super_vwma,
        a.wma AS super_wma,
        a.fishertransform_fisher AS super_fishertransform_fisher,
        a.fishertransform_trigger AS super_fishertransform_trigger,
        a.zigzag AS super_zigzag,
        a.atr AS super_atr,
        a.bop AS super_bop,
        a.choppinessindex AS super_choppinessindex,
        a.pmo AS super_pmo,
        a.pmo_signal AS super_pmo_signal,
        a.roc AS super_roc,
        a.truerange AS super_truerange,
        a.tsi AS super_tsi,
        a.ulcerindex AS super_ulcerindex,
        a.slope AS super_slope,
        a.standarddeviation AS super_standarddeviation
    FROM candle_data c
    JOIN all_indicators_data a
      ON c.symbol = a.symbol
     AND c.interval = a.interval
     AND c.datetime = a.datetime
    WHERE c.symbol = b.base_symbol
      AND c.interval = 'ONE_WEEK'
      AND date_trunc('week', c.datetime) < date_trunc('week', b.base_datetime)
    ORDER BY c.datetime DESC
    LIMIT 1
) super_data ON TRUE
LEFT JOIN LATERAL (
    SELECT
        c.open AS lower_open,
        c.high AS lower_high,
        c.low AS lower_low,
        c.close AS lower_close,
        c.volume AS lower_volume,
        a.aroon_up AS lower_aroon_up,
        a.aroon_down AS lower_aroon_down,
        a.adx AS lower_adx,
        a.pdi AS lower_pdi,
        a.mdi AS lower_mdi,
        a.elderray_bull_power AS lower_elderray_bull_power,
        a.elderray_bear_power AS lower_elderray_bear_power,
        a.gator_upper AS lower_gator_upper,
        a.gator_lower AS lower_gator_lower,
        a.gator_is_upper_expanding AS lower_gator_is_upper_expanding,
        a.gator_is_lower_expanding AS lower_gator_is_lower_expanding,
        a.hurst AS lower_hurst,
        a.ichimoku_tenkan_sen AS lower_ichimoku_tenkan_sen,
        a.ichimoku_kijun_sen AS lower_ichimoku_kijun_sen,
        a.ichimoku_senkou_span_a AS lower_ichimoku_senkou_span_a,
        a.ichimoku_senkou_span_b AS lower_ichimoku_senkou_span_b,
        a.ichimoku_chikou_span AS lower_ichimoku_chikou_span,
        a.macd AS lower_macd,
        a.macd_signal AS lower_macd_signal,
        a.macd_histogram AS lower_macd_histogram,
        a.supertrend AS lower_supertrend,
        a.vortex_pvi AS lower_vortex_pvi,
        a.vortex_nvi AS lower_vortex_nvi,
        a.alligator_jaw AS lower_alligator_jaw,
        a.alligator_teeth AS lower_alligator_teeth,
        a.alligator_lips AS lower_alligator_lips,
        a.bollingerbands_upper AS lower_bollingerbands_upper,
        a.bollingerbands_lower AS lower_bollingerbands_lower,
        a.donchianchannels_upper AS lower_donchianchannels_upper,
        a.donchianchannels_lower AS lower_donchianchannels_lower,
        a.fcb_upper AS lower_fcb_upper,
        a.fcb_lower AS lower_fcb_lower,
        a.keltnerchannels_upper AS lower_keltnerchannels_upper,
        a.keltnerchannels_lower AS lower_keltnerchannels_lower,
        a.keltnerchannels_center AS lower_keltnerchannels_center,
        a.maenvelopes_upper AS lower_maenvelopes_upper,
        a.maenvelopes_lower AS lower_maenvelopes_lower,
        a.pivotpoints_pp AS lower_pivotpoints_pp,
        a.pivotpoints_r1 AS lower_pivotpoints_r1,
        a.pivotpoints_s1 AS lower_pivotpoints_s1,
        a.rollingpivotpoints_pp AS lower_rollingpivotpoints_pp,
        a.rollingpivotpoints_r1 AS lower_rollingpivotpoints_r1,
        a.rollingpivotpoints_s1 AS lower_rollingpivotpoints_s1,
        a.starc_upper AS lower_starc_upper,
        a.starc_lower AS lower_starc_lower,
        a.standarddeviationchannels_upper AS lower_standarddeviationchannels_upper,
        a.standarddeviationchannels_lower AS lower_standarddeviationchannels_lower,
        a.awesomeoscillator AS lower_awesomeoscillator,
        a.cci AS lower_cci,
        a.connorsrsi AS lower_connorsrsi,
        a.dpo AS lower_dpo,
        a.rsi AS lower_rsi,
        a.stc AS lower_stc,
        a.smi AS lower_smi,
        a.stochasticoscillator_k AS lower_stochasticoscillator_k,
        a.stochasticoscillator_d AS lower_stochasticoscillator_d,
        a.stochasticrsi_rsi AS lower_stochasticrsi_rsi,
        a.stochasticrsi_signal AS lower_stochasticrsi_signal,
        a.trix AS lower_trix,
        a.ultimateoscillator AS lower_ultimateoscillator,
        a.williamsr AS lower_williamsr,
        a.chandelierexit AS lower_chandelierexit,
        a.parabolicsar AS lower_parabolicsar,
        a.volatilitystop AS lower_volatilitystop,
        a.williamsfractal_bull AS lower_williamsfractal_bull,
        a.williamsfractal_bear AS lower_williamsfractal_bear,
        a.adl AS lower_adl,
        a.cmf AS lower_cmf,
        a.chaikinoscillator AS lower_chaikinoscillator,
        a.forceindex AS lower_forceindex,
        a.kvo AS lower_kvo,
        a.mfi AS lower_mfi,
        a.obv AS lower_obv,
        a.pvo AS lower_pvo,
        a.alma AS lower_alma,
        a.dema AS lower_dema,
        a.epma AS lower_epma,
        a.ema5 AS lower_ema5,
        a.ema9 AS lower_ema9,
        a.ema13 AS lower_ema13,
        a.ema50 AS lower_ema50,
        a.hilberttransform AS lower_hilberttransform,
        a.hma AS lower_hma,
        a.kama AS lower_kama,
        a.mama AS lower_mama,
        a.fama AS lower_fama,
        a.sma AS lower_sma,
        a.smma AS lower_smma,
        a.t3 AS lower_t3,
        a.tema AS lower_tema,
        a.vwap AS lower_vwap,
        a.vwma AS lower_vwma,
        a.wma AS lower_wma,
        a.fishertransform_fisher AS lower_fishertransform_fisher,
        a.fishertransform_trigger AS lower_fishertransform_trigger,
        a.zigzag AS lower_zigzag,
        a.atr AS lower_atr,
        a.bop AS lower_bop,
        a.choppinessindex AS lower_choppinessindex,
        a.pmo AS lower_pmo,
        a.pmo_signal AS lower_pmo_signal,
        a.roc AS lower_roc,
        a.truerange AS lower_truerange,
        a.tsi AS lower_tsi,
        a.ulcerindex AS lower_ulcerindex,
        a.slope AS lower_slope,
        a.standarddeviation AS lower_standarddeviation
    FROM candle_data c
    JOIN all_indicators_data a
      ON c.symbol = a.symbol
     AND c.interval = a.interval
     AND c.datetime = a.datetime
    WHERE c.symbol = b.base_symbol
      AND c.interval = 'FIFTEEN_MINUTE'
      AND c.datetime >= b.base_datetime
      AND c.datetime < b.base_datetime + INTERVAL '1 hour'
    ORDER BY c.datetime DESC
    LIMIT 1
) lower_data ON TRUE

ORDER BY
    b.base_symbol,
    b.base_interval,
    b.base_datetime;
